<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Book Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .lds-dual-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 3px solid #4f46e5;
            border-color: #4f46e5 transparent #4f46e5 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .book-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .book-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .book-list-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .book-list-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .drag-handle {
            cursor: grab;
        }
        .sortable-ghost {
            background: #eef2ff;
            opacity: 0.7;
        }
        .author-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #eef2ff;
        }
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 80%;
            max-height: 80vh;
        }
        .close-image-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI Book Tracker v1.1</h1>
            <p class="text-md text-gray-600 mt-2">Your personal reading history from 2014 to present.</p>
        </header>

        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex flex-wrap gap-x-2 gap-y-2" aria-label="Tabs" id="year-tabs">
                </nav>
            </div>
        </div>

        <div id="main-content" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <!-- Bulk Add Form -->
            <div class="mb-6 pb-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold mb-3">Add Books to <span id="current-year-label"></span></h2>
                <form id="bulk-add-form">
                    <div id="bulk-book-rows" class="space-y-4">
                        <!-- Book rows will be added here by JS -->
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <button type="button" id="add-row-btn" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Add Another Book
                        </button>
                        <button type="submit" id="add-all-btn" class="inline-flex justify-center items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                            <span id="add-all-btn-text">Add All Books</span>
                            <div id="bulk-loader" class="hidden lds-dual-ring"></div>
                        </button>
                    </div>
                </form>
                <div id="bulk-progress-container" class="hidden mt-4">
                    <p id="bulk-progress-label" class="text-sm font-medium text-gray-700 mb-1"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="bulk-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div id="error-message" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>


            <div>
                <h3 class="text-lg font-semibold mb-4">Books Read in <span id="current-year-table-label"></span></h3>
                <div class="book-list-container overflow-x-auto max-h-[60vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cover</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month Read</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published Year</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="book-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div id="no-books-message" class="text-center py-10 text-gray-500">
                    <p>No books added for this year yet. Use the form above to add your first book!</p>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>Powered by Gemini AI. Your data is saved securely.</p>
            <p class="mt-1">User ID: <span id="user-id-display" class="font-mono"></span></p>
        </footer>
    </div>

    <div id="delete-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Delete Book
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Are you sure you want to delete this book? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                    <button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="image-modal" class="image-modal">
        <span class="close-image-modal" id="close-image-modal">&times;</span>
        <img class="image-modal-content" id="full-image">
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, deleteDoc, setLogLevel, orderBy, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentYear = new Date().getFullYear();
        let db, auth, userId;
        let unsubscribeFromFirestore; 
        let sortableInstance = null; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyCP1bHz8yFWHgFRrMKlmRY3BcC8JDVorR8",
            authDomain: "book-tracker-4987d.firebaseapp.com",
            projectId: "book-tracker-4987d",
            storageBucket: "book-tracker-4987d.appspot.com",
            messagingSenderId: "236216243093",
            appId: "1:236216243093:web:a65bbddebb01fd5182dc9c"
        };

        const yearTabsContainer = document.getElementById('year-tabs');
        const bookList = document.getElementById('book-list');
        const bulkAddForm = document.getElementById('bulk-add-form');
        const bulkBookRows = document.getElementById('bulk-book-rows');
        const addRowBtn = document.getElementById('add-row-btn');
        const addAllBtn = document.getElementById('add-all-btn');
        const addAllBtnText = document.getElementById('add-all-btn-text');
        const bulkLoader = document.getElementById('bulk-loader');
        const bulkProgressContainer = document.getElementById('bulk-progress-container');
        const bulkProgressLabel = document.getElementById('bulk-progress-label');
        const bulkProgressBar = document.getElementById('bulk-progress-bar');
        const errorMessage = document.getElementById('error-message');
        const noBooksMessage = document.getElementById('no-books-message');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const imageModal = document.getElementById('image-modal');
        const fullImage = document.getElementById('full-image');
        const closeImageModalBtn = document.getElementById('close-image-modal');

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        initializeAppUI();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                             console.error("Anonymous sign-in failed:", error);
                             showError("Could not establish a secure session. Please refresh the page.");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize the application. Please check the console for details.");
            }
        }

        function initializeAppUI() {
            if (!userId) return;
            setupTabs();
            updateActiveTab();
            addRowBtn.addEventListener('click', addBulkRow);
            bulkAddForm.addEventListener('submit', handleBulkAdd);
            addBulkRow(); 

            closeImageModalBtn.addEventListener('click', closeImageModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });
        }

        function addBulkRow() {
            const rowId = `row-${Date.now()}`;
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'grid grid-cols-1 md:grid-cols-10 gap-4 items-end p-2 border rounded-md';
            row.innerHTML = `
                <div class="md:col-span-4 relative">
                    <label class="block text-sm font-medium text-gray-700">Book Title</label>
                    <input type="text" required class="mt-1 bulk-title w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="md:col-span-3 relative">
                    <label class="block text-sm font-medium text-gray-700">Author</label>
                    <input type="text" required class="mt-1 bulk-author w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" autocomplete="off">
                    <div class="author-suggestions hidden"></div>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Month Read</label>
                    <select required class="mt-1 bulk-month w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Select</option>
                        <option value="January">Jan</option>
                        <option value="February">Feb</option>
                        <option value="March">Mar</option>
                        <option value="April">Apr</option>
                        <option value="May">May</option>
                        <option value="June">Jun</option>
                        <option value="July">Jul</option>
                        <option value="August">Aug</option>
                        <option value="September">Sep</option>
                        <option value="October">Oct</option>
                        <option value="November">Nov</option>
                        <option value="December">Dec</option>
                    </select>
                </div>
                <div class="md:col-span-1 flex items-center justify-end">
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="document.getElementById('${rowId}').remove()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            bulkBookRows.appendChild(row);

            const titleInput = row.querySelector('.bulk-title');
            titleInput.addEventListener('blur', () => handleTitleBlur(row));
        }

        function setupTabs() {
            yearTabsContainer.innerHTML = '';
            const endYear = new Date().getFullYear();
            for (let year = endYear; year >= 2014; year--) {
                const tab = document.createElement('a');
                tab.href = '#';
                tab.dataset.year = year;
                tab.className = 'whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg hover:bg-indigo-50';
                tab.textContent = year;
                if (year === currentYear) {
                    tab.classList.add('tab-active');
                }
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentYear = parseInt(e.target.dataset.year);
                    updateActiveTab();
                });
                yearTabsContainer.appendChild(tab);
            }
        }

        function updateActiveTab() {
            document.querySelectorAll('#year-tabs a').forEach(tab => {
                if (parseInt(tab.dataset.year) === currentYear) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            document.getElementById('current-year-label').textContent = currentYear;
            document.getElementById('current-year-table-label').textContent = currentYear;
            fetchAndRenderBooks();
        }

        function renderBooks(books) {
            bookList.innerHTML = '';
            if (books.length === 0) {
                noBooksMessage.classList.remove('hidden');
                bookList.classList.add('hidden');
            } else {
                noBooksMessage.classList.add('hidden');
                bookList.classList.remove('hidden');

                books.forEach(book => {
                    const row = document.createElement('tr');
                    row.id = book.id; 
                    row.innerHTML = `
                        <td class="px-2 py-4 whitespace-nowrap text-gray-400 text-center drag-handle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="inline-block" viewBox="0 0 16 16">
                              <path d="M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1 3a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-1 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm5-7a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM10 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-1 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                            </svg>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${book.coverImageUrl || 'https://placehold.co/80x120/e2e8f0/94a3b8?text=No+Image'}" 
                                 alt="Cover of ${book.title}" 
                                 class="h-20 w-auto object-contain rounded-md shadow-sm thumbnail-img cursor-pointer"
                                 onerror="this.onerror=null;this.src='https://placehold.co/80x120/e2e8f0/94a3b8?text=Error';">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${book.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.author}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.monthRead || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.publicationYear || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${book.id}" class="text-red-600 hover:text-red-900 delete-btn">Delete</button>
                        </td>
                    `;
                    bookList.appendChild(row);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteBook);
                });

                document.querySelectorAll('.thumbnail-img').forEach(img => {
                    img.addEventListener('click', (e) => openImageModal(e.target.src));
                });
            }
            initializeSortable();
        }

        function fetchAndRenderBooks() {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }

            if (!db || !userId) return;
            
            const booksCollectionRef = collection(db, `users/${userId}/books`);
            const q = query(booksCollectionRef, where("yearRead", "==", currentYear), orderBy("order", "asc"));

            unsubscribeFromFirestore = onSnapshot(q, (querySnapshot) => {
                const books = [];
                querySnapshot.forEach((doc) => {
                    books.push({ id: doc.id, ...doc.data() });
                });
                renderBooks(books);
            }, (error) => {
                console.error("Error fetching books:", error);
                showError("Could not fetch your book list. Please check your connection or refresh.");
            });
        }

        async function handleBulkAdd(e) {
            e.preventDefault();
            const rows = bulkBookRows.querySelectorAll('.grid');
            if (rows.length === 0) {
                showError("Please add at least one book to the list.");
                return;
            }

            setBulkLoading(true);
            let processedCount = 0;
            const totalBooks = rows.length;
            updateBulkProgress(processedCount, totalBooks);

            const booksToAdd = [];
            for (const row of rows) {
                const title = row.querySelector('.bulk-title').value.trim();
                const author = row.querySelector('.bulk-author').value.trim();
                const monthRead = row.querySelector('.bulk-month').value;

                if (title && author && monthRead) {
                    try {
                        const bookData = await fetchBookDataWithRetry(title, author);
                        booksToAdd.push({
                            title,
                            author,
                            monthRead,
                            yearRead: currentYear,
                            publicationYear: bookData.publicationYear || 'Unknown',
                            coverImageUrl: bookData.coverImageUrl || '',
                            createdAt: new Date()
                        });
                    } catch (error) {
                        console.error(`Failed to fetch data for ${title}:`, error);
                        booksToAdd.push({ title, author, monthRead, yearRead: currentYear });
                    }
                }
                processedCount++;
                updateBulkProgress(processedCount, totalBooks);
            }

            const batch = writeBatch(db);
            const booksCollectionRef = collection(db, `users/${userId}/books`);
            let currentOrder = bookList.children.length;
            
            booksToAdd.forEach(book => {
                const newBookRef = doc(booksCollectionRef);
                batch.set(newBookRef, { ...book, order: currentOrder++ });
            });

            try {
                await batch.commit();
                bulkBookRows.innerHTML = '';
                addBulkRow();
                hideError();
            } catch (error) {
                console.error("Error adding books in bulk:", error);
                showError("There was an error saving your books. Please try again.");
            } finally {
                setBulkLoading(false);
            }
        }

        async function handleDeleteBook(e) {
            const bookId = e.target.dataset.id;
            if (!bookId) return;

            deleteModal.classList.remove('hidden');

            const userChoice = new Promise(resolve => {
                confirmDeleteBtn.onclick = () => resolve(true);
                cancelDeleteBtn.onclick = () => resolve(false);
            });

            const shouldDelete = await userChoice;
            deleteModal.classList.add('hidden');

            if (shouldDelete) {
                 try {
                    await deleteDoc(doc(db, `users/${userId}/books`, bookId));
                } catch (error) {
                    console.error("Error deleting book:", error);
                    showError("Failed to delete the book. Please try again.");
                }
            }
        }
        
        function initializeSortable() {
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(bookList, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: updateBookOrder,
            });
        }

        async function updateBookOrder() {
            const batch = writeBatch(db);
            const rows = bookList.querySelectorAll('tr');

            rows.forEach((row, index) => {
                const bookId = row.id;
                if (bookId) {
                    const bookRef = doc(db, `users/${userId}/books`, bookId);
                    batch.update(bookRef, { order: index });
                }
            });

            try {
                await batch.commit();
            } catch (error) {
                console.error("Failed to update book order:", error);
                showError("Could not save the new order. Please try again.");
            }
        }

        function openImageModal(src) {
            if (src.includes('placehold.co')) return;
            fullImage.src = src;
            imageModal.style.display = "flex";
        }

        function closeImageModal() {
            imageModal.style.display = "none";
        }

        async function handleTitleBlur(row) {
            const titleInput = row.querySelector('.bulk-title');
            const authorInput = row.querySelector('.bulk-author');
            const suggestionsContainer = row.querySelector('.author-suggestions');
            const title = titleInput.value.trim();
            
            if (title) {
                const suggestions = await fetchAuthorSuggestions(title);
                showSuggestions(suggestions, authorInput, suggestionsContainer);
            }
        }

        function showSuggestions(suggestions, authorInput, suggestionsContainer) {
            suggestionsContainer.innerHTML = '';
            if (suggestions.length > 0) {
                suggestionsContainer.classList.remove('hidden');
                suggestions.forEach(author => {
                    const div = document.createElement('div');
                    div.textContent = author;
                    div.className = 'suggestion-item';
                    div.onmousedown = () => { // Use onmousedown to fire before blur
                        authorInput.value = author;
                        suggestionsContainer.classList.add('hidden');
                    };
                    suggestionsContainer.appendChild(div);
                });
                 document.addEventListener('click', (e) => {
                    if (!authorInput.parentElement.contains(e.target)) {
                       suggestionsContainer.classList.add('hidden');
                    }
                }, { once: true });
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }

        async function fetchAuthorSuggestions(title) {
            const prompt = `Provide a list of authors who have written a book titled "${title}". Return only a JSON array of strings, like ["Author One", "Author Two"]. If you can't find any, return an empty array.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            authors: {
                                type: "ARRAY",
                                items: { type: "STRING" }
                            }
                        },
                        required: ["authors"]
                    }
                }
            };

            try {
                const apiKey = firebaseConfig.apiKey; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`Author suggestion API failed: ${errorBody.error.message}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    const parsedResult = JSON.parse(result.candidates[0].content.parts[0].text);
                    return parsedResult.authors || [];
                }
                return [];
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchBookData(title, author) {
            const prompt = `Find the book cover for the title "${title}" by author "${author}". Prioritize the UK edition cover from amazon.co.uk if possible. Provide the original publication year and a publicly accessible, hotlink-safe URL for the book cover image. If you cannot find a confident match for this specific book, return an empty string for the coverImageUrl instead of guessing.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            publicationYear: { type: "STRING" },
                            coverImageUrl: { type: "STRING" }
                        },
                        required: ["publicationYear", "coverImageUrl"]
                    }
                }
            };
            
            const apiKey = firebaseConfig.apiKey; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API request failed with status ${response.status}: ${errorBody.error.message}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                return JSON.parse(text);
            } else {
                console.warn("AI response was empty or malformed:", result);
                return { publicationYear: 'Not Found', coverImageUrl: '' };
            }
        }

        async function fetchBookDataWithRetry(title, author, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fetchBookData(title, author);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.log(`Retrying API call for ${title} (${i + 1}/${retries})...`);
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        function setBulkLoading(isLoading) {
            if (isLoading) {
                addAllBtn.disabled = true;
                bulkLoader.classList.remove('hidden');
                addAllBtnText.classList.add('hidden');
                bulkProgressContainer.classList.remove('hidden');
            } else {
                addAllBtn.disabled = false;
                bulkLoader.classList.add('hidden');
                addAllBtnText.classList.remove('hidden');
                setTimeout(() => bulkProgressContainer.classList.add('hidden'), 2000);
            }
        }

        function updateBulkProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            bulkProgressLabel.textContent = `Processing ${current} of ${total} books...`;
            bulkProgressBar.style.width = `${percentage}%`;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        window.onload = initializeFirebase;

    </script>
</body>
</html>
