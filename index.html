<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Book Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Added SortableJS for drag-and-drop functionality -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .lds-dual-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 3px solid #4f46e5;
            border-color: #4f46e5 transparent #4f46e5 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Custom scrollbar for book list */
        .book-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .book-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .book-list-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .book-list-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* Style for the drag handle */
        .drag-handle {
            cursor: grab;
        }
        .sortable-ghost {
            background: #eef2ff;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI Book Tracker</h1>
            <p class="text-md text-gray-600 mt-2">Your personal reading history from 2014 to present.</p>
        </header>

        <!-- Tabs for years -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex flex-wrap gap-x-2 gap-y-2" aria-label="Tabs" id="year-tabs">
                    <!-- Year tabs will be generated by JS -->
                </nav>
            </div>
        </div>

        <div id="main-content" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <!-- Form to add a new book -->
            <div class="mb-6 pb-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold mb-3">Add a New Book to <span id="current-year-label"></span></h2>
                <form id="add-book-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="book-title" class="block text-sm font-medium text-gray-700">Book Title</label>
                        <input type="text" id="book-title" name="book-title" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-1">
                        <label for="book-author" class="block text-sm font-medium text-gray-700">Author</label>
                        <input type="text" id="book-author" name="book-author" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" id="add-book-btn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span id="btn-text">Add Book & Fetch Info</span>
                            <div id="loader" class="hidden lds-dual-ring"></div>
                        </button>
                    </div>
                </form>
                 <div id="error-message" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>

            <!-- Book List Table -->
            <div>
                <h3 class="text-lg font-semibold mb-4">Books Read in <span id="current-year-table-label"></span></h3>
                <div class="book-list-container overflow-x-auto max-h-[60vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cover</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published Year</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="book-list" class="bg-white divide-y divide-gray-200">
                            <!-- Book rows will be generated by JS -->
                        </tbody>
                    </table>
                </div>
                 <div id="no-books-message" class="text-center py-10 text-gray-500">
                    <p>No books added for this year yet. Use the form above to add your first book!</p>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>Powered by Gemini AI. Your data is saved securely.</p>
            <p class="mt-1">User ID: <span id="user-id-display" class="font-mono"></span></p>
        </footer>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed z-50 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Delete Book
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Are you sure you want to delete this book? This action cannot be undone.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                    <button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, setLogLevel, orderBy, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        let currentYear = new Date().getFullYear();
        let db, auth, userId;
        let unsubscribeFromFirestore; // To detach listener when changing years
        let sortableInstance = null; // To hold the SortableJS instance

        // --- DOM ELEMENTS ---
        const yearTabsContainer = document.getElementById('year-tabs');
        const bookList = document.getElementById('book-list');
        const addBookForm = document.getElementById('add-book-form');
        const titleInput = document.getElementById('book-title');
        const authorInput = document.getElementById('book-author');
        const addBookBtn = document.getElementById('add-book-btn');
        const loader = document.getElementById('loader');
        const btnText = document.getElementById('btn-text');
        const errorMessage = document.getElementById('error-message');
        const noBooksMessage = document.getElementById('no-books-message');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');


        // --- FIREBASE SETUP ---
        async function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-tracker-ai';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (!firebaseConfig) {
                console.error("Firebase config is not available.");
                showError("Application is not configured correctly. Cannot connect to the database.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        initializeAppUI();
                    } else {
                        try {
                             if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                             console.error("Anonymous sign-in failed:", error);
                             showError("Could not establish a secure session. Please refresh the page.");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize the application. Please check the console for details.");
            }
        }

        // --- UI INITIALIZATION & RENDERING ---
        function initializeAppUI() {
            if (!userId) return;
            setupTabs();
            updateActiveTab();
            addBookForm.addEventListener('submit', handleAddBook);
        }

        function setupTabs() {
            yearTabsContainer.innerHTML = '';
            const endYear = new Date().getFullYear();
            for (let year = endYear; year >= 2014; year--) {
                const tab = document.createElement('a');
                tab.href = '#';
                tab.dataset.year = year;
                tab.className = 'whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg hover:bg-indigo-50';
                tab.textContent = year;
                if (year === currentYear) {
                    tab.classList.add('tab-active');
                }
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentYear = parseInt(e.target.dataset.year);
                    updateActiveTab();
                });
                yearTabsContainer.appendChild(tab);
            }
        }

        function updateActiveTab() {
            document.querySelectorAll('#year-tabs a').forEach(tab => {
                if (parseInt(tab.dataset.year) === currentYear) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            document.getElementById('current-year-label').textContent = currentYear;
            document.getElementById('current-year-table-label').textContent = currentYear;
            fetchAndRenderBooks();
        }

        function renderBooks(books) {
            bookList.innerHTML = '';
            if (books.length === 0) {
                noBooksMessage.classList.remove('hidden');
                bookList.classList.add('hidden');
            } else {
                noBooksMessage.classList.add('hidden');
                bookList.classList.remove('hidden');

                books.forEach(book => {
                    const row = document.createElement('tr');
                    // Use book.id for the row's ID attribute for easy lookup
                    row.id = book.id; 
                    row.innerHTML = `
                        <td class="px-2 py-4 whitespace-nowrap text-gray-400 text-center drag-handle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="inline-block" viewBox="0 0 16 16">
                              <path d="M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1 3a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-1 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm5-7a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM10 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-1 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                            </svg>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img src="${book.coverImageUrl || 'https://placehold.co/80x120/e2e8f0/94a3b8?text=No+Image'}" 
                                 alt="Cover of ${book.title}" 
                                 class="h-20 w-auto object-contain rounded-md shadow-sm"
                                 onerror="this.onerror=null;this.src='https://placehold.co/80x120/e2e8f0/94a3b8?text=Error';">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${book.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.author}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.publicationYear || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button data-id="${book.id}" class="text-red-600 hover:text-red-900 delete-btn">Delete</button>
                        </td>
                    `;
                    bookList.appendChild(row);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteBook);
                });
            }
            // Initialize or re-initialize sortable functionality
            initializeSortable();
        }

        // --- DATA HANDLING (FIRESTORE & SORTABLEJS) ---
        function fetchAndRenderBooks() {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }

            if (!db || !userId) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-tracker-ai';
            const booksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/books`);
            // Query books for the current year and order them by the 'order' field
            const q = query(booksCollectionRef, where("yearRead", "==", currentYear), orderBy("order", "asc"));

            unsubscribeFromFirestore = onSnapshot(q, (querySnapshot) => {
                const books = [];
                querySnapshot.forEach((doc) => {
                    books.push({ id: doc.id, ...doc.data() });
                });
                renderBooks(books);
            }, (error) => {
                console.error("Error fetching books:", error);
                showError("Could not fetch your book list. Please check your connection or refresh.");
            });
        }

        async function handleAddBook(e) {
            e.preventDefault();
            const title = titleInput.value.trim();
            const author = authorInput.value.trim();

            if (!title || !author) {
                showError("Please enter both a title and an author.");
                return;
            }

            setLoading(true);

            try {
                const bookData = await fetchBookDataWithRetry(title, author);
                
                // New books get an order value that places them at the end of the current list
                const newOrder = bookList.children.length;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-tracker-ai';
                const booksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/books`);
                await addDoc(booksCollectionRef, {
                    title: title,
                    author: author,
                    yearRead: currentYear,
                    publicationYear: bookData.publicationYear || 'Unknown',
                    coverImageUrl: bookData.coverImageUrl || '',
                    createdAt: new Date(),
                    order: newOrder // Add the order field
                });

                addBookForm.reset();
                hideError();

            } catch (error) {
                console.error("Error adding book:", error);
                showError(error.message || "Failed to add book. The AI might not have found it.");
            } finally {
                setLoading(false);
            }
        }

        async function handleDeleteBook(e) {
            const bookId = e.target.dataset.id;
            if (!bookId) return;

            deleteModal.classList.remove('hidden');

            const userChoice = new Promise(resolve => {
                confirmDeleteBtn.onclick = () => resolve(true);
                cancelDeleteBtn.onclick = () => resolve(false);
            });

            const shouldDelete = await userChoice;
            deleteModal.classList.add('hidden');

            if (shouldDelete) {
                 try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-tracker-ai';
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/books`, bookId));
                    // Note: Deleting a book will leave a gap in the 'order' sequence. 
                    // This is okay, as orderBy still works. Re-ordering after delete could be a future enhancement.
                } catch (error) {
                    console.error("Error deleting book:", error);
                    showError("Failed to delete the book. Please try again.");
                }
            }
        }
        
        function initializeSortable() {
            if (sortableInstance) {
                sortableInstance.destroy(); // Destroy previous instance to prevent issues
            }
            sortableInstance = new Sortable(bookList, {
                handle: '.drag-handle', // Specify the drag handle
                animation: 150, // Animation speed
                ghostClass: 'sortable-ghost', // Class for the drop placeholder
                onEnd: updateBookOrder, // Callback after dragging ends
            });
        }

        async function updateBookOrder() {
            const batch = writeBatch(db);
            const rows = bookList.querySelectorAll('tr');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'book-tracker-ai';

            rows.forEach((row, index) => {
                const bookId = row.id;
                if (bookId) {
                    const bookRef = doc(db, `artifacts/${appId}/users/${userId}/books`, bookId);
                    batch.update(bookRef, { order: index });
                }
            });

            try {
                await batch.commit();
            } catch (error) {
                console.error("Failed to update book order:", error);
                showError("Could not save the new order. Please try again.");
            }
        }

        // --- AI (GEMINI) LOGIC ---
        async function fetchBookData(title, author) {
            const prompt = `Given the book title "${title}" and author "${author}", find the original publication year and a URL for the book cover image.`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            publicationYear: { type: "STRING" },
                            coverImageUrl: { type: "STRING" }
                        },
                        required: ["publicationYear", "coverImageUrl"]
                    }
                }
            };
            
            const apiKey = ""; // Provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                return JSON.parse(text);
            } else {
                console.warn("AI response was empty or malformed:", result);
                return { publicationYear: 'Not Found', coverImageUrl: '' };
            }
        }

        async function fetchBookDataWithRetry(title, author, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fetchBookData(title, author);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.log(`Retrying API call (${i + 1}/${retries})...`);
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        // --- UI HELPER FUNCTIONS ---
        function setLoading(isLoading) {
            if (isLoading) {
                addBookBtn.disabled = true;
                loader.classList.remove('hidden');
                btnText.classList.add('hidden');
            } else {
                addBookBtn.disabled = false;
                loader.classList.add('hidden');
                btnText.classList.remove('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // --- INITIALIZE THE APP ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
