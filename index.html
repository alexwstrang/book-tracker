<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Book Tracker with Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .lds-dual-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 3px solid #4f46e5;
            border-color: #4f46e5 transparent #4f46e5 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }
        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .book-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .book-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .book-list-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .book-list-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .drag-handle {
            cursor: grab;
        }
        .sortable-ghost {
            background: #eef2ff;
            opacity: 0.7;
        }
        .suggestions-container {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: #eef2ff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .editable-cell {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        .editable-cell:hover {
            background-color: #f0f0f0;
        }
        .editable-select {
            border: none;
            background-color: transparent;
            width: 100%;
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 80%;
            max-height: 80vh;
        }
        .close-image-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI Book Tracker v2.5</h1>
            <p class="text-md text-gray-600 mt-2">Your personal reading history from 2014 to present.</p>
        </header>

        <div class="mb-6 flex justify-between items-center border-b border-gray-200">
            <nav class="-mb-px flex flex-wrap gap-x-2 gap-y-2" aria-label="Tabs" id="year-tabs">
            </nav>
            <button id="view-stats-btn" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">View Stats</button>
        </div>

        <div id="main-content" class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="mb-6 pb-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold mb-3">Add Books to <span id="current-year-label"></span></h2>
                
                <div class="mb-4">
                    <a href="#" id="toggle-import-btn" class="text-sm text-indigo-600 hover:underline">Show/Hide Bulk Import Options</a>
                </div>

                <div id="import-section" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-2">Import from CSV</h3>
                    <p class="text-sm text-gray-600 mb-2">Upload a CSV with Title/Author or ISBN. <a href="#" id="download-template-link" class="text-indigo-600 hover:underline">Download Title/Author template</a> or <a href="#" id="download-isbn-template-link" class="text-indigo-600 hover:underline">ISBN template</a>.</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                </div>

                <form id="bulk-add-form">
                    <div id="bulk-book-rows" class="space-y-4"></div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="md:col-span-1">
                             <label for="isbn-input" class="block text-sm font-medium text-gray-700">Add by ISBN</label>
                             <div class="flex items-center space-x-2 mt-1">
                                <input type="text" id="isbn-input" placeholder="e.g., 9780345391803" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <button type="button" id="find-by-isbn-btn" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Find</button>
                            </div>
                        </div>
                        <div class="md:col-span-2 flex justify-end space-x-4">
                            <button type="button" id="add-row-btn" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Add Another Book
                            </button>
                            <button type="submit" id="add-all-btn" class="inline-flex justify-center items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                                <span id="add-all-btn-text">Add All Books</span>
                                <div id="bulk-loader" class="hidden lds-dual-ring"></div>
                            </button>
                        </div>
                    </div>
                </form>
                <div id="bulk-progress-container" class="hidden mt-4">
                    <p id="bulk-progress-label" class="text-sm font-medium text-gray-700 mb-1"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="bulk-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div id="error-message" class="text-red-500 text-sm mt-2 hidden"></div>
            </div>

            <div>
                <h3 class="text-lg font-semibold mb-4">Books Read in <span id="current-year-table-label"></span></h3>
                <div class="book-list-container overflow-x-auto max-h-[60vh] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cover</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month Read</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Genre</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="book-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div id="no-books-message" class="text-center py-10 text-gray-500">
                    <p>No books added for this year yet. Use the form above to add your first book!</p>
                </div>
            </div>
        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>Powered by Gemini AI. Your data is saved securely.</p>
            <p class="mt-1">User ID: <span id="user-id-display" class="font-mono"></span></p>
        </footer>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-4xl w-full mx-auto my-auto p-6 relative">
             <button id="close-stats-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
             <h2 class="text-2xl font-bold mb-4">Reading Statistics</h2>
             <div class="mb-4">
                <div class="inline-flex rounded-md shadow-sm">
                    <button id="stats-year-btn" class="px-4 py-2 text-sm font-medium text-indigo-700 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-indigo-700">Stats for 2025</button>
                    <button id="stats-all-btn" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 focus:z-10 focus:ring-2 focus:ring-indigo-700">All Time</button>
                </div>
             </div>
             <div id="stats-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600">Total Books Read</p>
                        <p id="stats-total-books" class="text-3xl font-bold"></p>
                    </div>
                    <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600">Unique Authors</p>
                        <p id="stats-unique-authors" class="text-3xl font-bold"></p>
                    </div>
                     <div class="p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600">Most Read Author</p>
                        <p id="stats-top-author" class="text-xl font-bold truncate"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold mb-2">Fiction vs. Non-Fiction</h3>
                        <canvas id="fiction-chart"></canvas>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">Top Genres</h3>
                        <canvas id="genre-chart"></canvas>
                    </div>
                </div>
             </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-2xl w-full mx-auto my-auto p-6 relative">
             <button id="close-review-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
             <h2 class="text-2xl font-bold mb-2">Review Book</h2>
             <p class="text-sm text-gray-600 mb-4">The AI couldn't find a confident match. Is it one of these?</p>
             <div id="review-suggestions" class="space-y-2"></div>
        </div>
    </div>
    
    <!-- Artwork Modal -->
    <div id="artwork-modal" class="modal">
        <div class="bg-white rounded-lg shadow-xl m-4 sm:m-8 max-w-2xl w-full mx-auto my-auto p-6 relative">
             <button id="close-artwork-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
             <h2 class="text-2xl font-bold mb-2">Choose Artwork</h2>
             <p class="text-sm text-gray-600 mb-4">Select the correct cover for this book.</p>
             <div id="artwork-suggestions" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>
    </div>
    
    <div id="genre-suggestions-container" class="suggestions-container hidden"></div>
    
    <div id="image-modal" class="modal">
        <span class="close-image-modal" id="close-image-modal">&times;</span>
        <img class="image-modal-content" id="full-image">
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, deleteDoc, setLogLevel, orderBy, writeBatch, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let currentYear = new Date().getFullYear();
        let db, auth, userId;
        let unsubscribeFromFirestore; 
        let sortableInstance = null; 
        let fictionChart, genreChart;
        let allUserGenres = [];
        
        const firebaseConfig = {
            apiKey: "AIzaSyCP1bHz8yFWHgFRrMKlmRY3BcC8JDVorR8",
            authDomain: "book-tracker-4987d.firebaseapp.com",
            projectId: "book-tracker-4987d",
            storageBucket: "book-tracker-4987d.appspot.com",
            messagingSenderId: "236216243093",
            appId: "1:236216243093:web:a65bbddebb01fd5182dc9c"
        };

        const yearTabsContainer = document.getElementById('year-tabs');
        const bookList = document.getElementById('book-list');
        const bulkAddForm = document.getElementById('bulk-add-form');
        const bulkBookRows = document.getElementById('bulk-book-rows');
        const addRowBtn = document.getElementById('add-row-btn');
        const addAllBtn = document.getElementById('add-all-btn');
        const addAllBtnText = document.getElementById('add-all-btn-text');
        const bulkLoader = document.getElementById('bulk-loader');
        const bulkProgressContainer = document.getElementById('bulk-progress-container');
        const bulkProgressLabel = document.getElementById('bulk-progress-label');
        const bulkProgressBar = document.getElementById('bulk-progress-bar');
        const errorMessage = document.getElementById('error-message');
        const noBooksMessage = document.getElementById('no-books-message');
        const viewStatsBtn = document.getElementById('view-stats-btn');
        const statsModal = document.getElementById('stats-modal');
        const closeStatsModalBtn = document.getElementById('close-stats-modal');
        const statsYearBtn = document.getElementById('stats-year-btn');
        const statsAllBtn = document.getElementById('stats-all-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const downloadTemplateLink = document.getElementById('download-template-link');
        const downloadIsbnTemplateLink = document.getElementById('download-isbn-template-link');
        const reviewModal = document.getElementById('review-modal');
        const closeReviewModalBtn = document.getElementById('close-review-modal');
        const reviewSuggestionsContainer = document.getElementById('review-suggestions');
        const artworkModal = document.getElementById('artwork-modal');
        const closeArtworkModalBtn = document.getElementById('close-artwork-modal');
        const artworkSuggestionsContainer = document.getElementById('artwork-suggestions');
        const isbnInput = document.getElementById('isbn-input');
        const findByIsbnBtn = document.getElementById('find-by-isbn-btn');
        const toggleImportBtn = document.getElementById('toggle-import-btn');
        const importSection = document.getElementById('import-section');
        const genreSuggestionsContainer = document.getElementById('genre-suggestions-container');
        const imageModal = document.getElementById('image-modal');
        const fullImage = document.getElementById('full-image');
        const closeImageModalBtn = document.getElementById('close-image-modal');

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        await fetchAllUserGenres();
                        initializeAppUI();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                             console.error("Anonymous sign-in failed:", error);
                             showError("Could not establish a secure session. Please refresh the page.");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showError("Failed to initialize the application. Please check the console for details.");
            }
        }

        function initializeAppUI() {
            if (!userId) return;
            setupTabs();
            updateActiveTab();
            addRowBtn.addEventListener('click', () => addBulkRow());
            bulkAddForm.addEventListener('submit', handleBulkAdd);
            addBulkRow(); 

            viewStatsBtn.addEventListener('click', openStatsModal);
            closeStatsModalBtn.addEventListener('click', () => statsModal.style.display = 'none');
            statsYearBtn.addEventListener('click', () => generateStats('year'));
            statsAllBtn.addEventListener('click', () => generateStats('all'));
            csvFileInput.addEventListener('change', handleCsvUpload);
            downloadTemplateLink.addEventListener('click', (e) => downloadCsvTemplate(e, 'title'));
            downloadIsbnTemplateLink.addEventListener('click', (e) => downloadCsvTemplate(e, 'isbn'));
            closeReviewModalBtn.addEventListener('click', () => reviewModal.style.display = 'none');
            closeArtworkModalBtn.addEventListener('click', () => artworkModal.style.display = 'none');
            findByIsbnBtn.addEventListener('click', handleIsbnSearch);
            toggleImportBtn.addEventListener('click', (e) => {
                e.preventDefault();
                importSection.classList.toggle('hidden');
                e.target.textContent = importSection.classList.contains('hidden') ? 'Show Import Options' : 'Hide Import Options';
            });
            closeImageModalBtn.addEventListener('click', closeImageModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) closeImageModal();
            });
        }

        function addBulkRow(book = { title: '', author: '', month: '', publicationYear: '', olid: '', isbn: '' }) {
            const rowId = `row-${Date.now()}`;
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'grid grid-cols-1 md:grid-cols-10 gap-4 items-end p-2 border rounded-md';
            row.dataset.publicationYear = book.publicationYear;
            row.dataset.olid = book.olid;
            row.dataset.isbn = book.isbn;
            row.innerHTML = `
                <div class="md:col-span-4 relative">
                    <label class="block text-sm font-medium text-gray-700">Book Title</label>
                    <input type="text" required class="mt-1 bulk-title w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" autocomplete="off" value="${book.title}">
                    <div class="title-suggestions suggestions-container hidden"></div>
                </div>
                <div class="md:col-span-3 relative">
                    <label class="block text-sm font-medium text-gray-700">Author</label>
                    <input type="text" required class="mt-1 bulk-author w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" autocomplete="off" value="${book.author}">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Month Read</label>
                    <select required class="mt-1 bulk-month w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Select</option>
                        <option value="January" ${book.month === 'January' ? 'selected' : ''}>Jan</option>
                        <option value="February" ${book.month === 'February' ? 'selected' : ''}>Feb</option>
                        <option value="March" ${book.month === 'March' ? 'selected' : ''}>Mar</option>
                        <option value="April" ${book.month === 'April' ? 'selected' : ''}>Apr</option>
                        <option value="May" ${book.month === 'May' ? 'selected' : ''}>May</option>
                        <option value="June" ${book.month === 'June' ? 'selected' : ''}>Jun</option>
                        <option value="July" ${book.month === 'July' ? 'selected' : ''}>Jul</option>
                        <option value="August" ${book.month === 'August' ? 'selected' : ''}>Aug</option>
                        <option value="September" ${book.month === 'September' ? 'selected' : ''}>Sep</option>
                        <option value="October" ${book.month === 'October' ? 'selected' : ''}>Oct</option>
                        <option value="November" ${book.month === 'November' ? 'selected' : ''}>Nov</option>
                        <option value="December" ${book.month === 'December' ? 'selected' : ''}>Dec</option>
                    </select>
                </div>
                <div class="md:col-span-1 flex items-center justify-end">
                    <button type="button" class="text-red-500 hover:text-red-700" onclick="document.getElementById('${rowId}').remove()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            bulkBookRows.appendChild(row);

            const titleInput = row.querySelector('.bulk-title');
            titleInput.addEventListener('input', debounce((e) => handleTitleInput(e.target.closest('.grid')), 500));
        }

        function setupTabs() {
            yearTabsContainer.innerHTML = '';
            const endYear = new Date().getFullYear();
            for (let year = endYear; year >= 2014; year--) {
                const tab = document.createElement('a');
                tab.href = '#';
                tab.dataset.year = year;
                tab.className = 'whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-lg hover:bg-indigo-50';
                tab.textContent = year;
                if (year === currentYear) {
                    tab.classList.add('tab-active');
                }
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentYear = parseInt(e.target.dataset.year);
                    updateActiveTab();
                });
                yearTabsContainer.appendChild(tab);
            }
        }

        function updateActiveTab() {
            document.querySelectorAll('#year-tabs a').forEach(tab => {
                if (parseInt(tab.dataset.year) === currentYear) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            document.getElementById('current-year-label').textContent = currentYear;
            document.getElementById('current-year-table-label').textContent = currentYear;
            fetchAndRenderBooks();
        }

        function renderBooks(books) {
            bookList.innerHTML = '';
            if (books.length === 0) {
                noBooksMessage.classList.remove('hidden');
                bookList.classList.add('hidden');
            } else {
                noBooksMessage.classList.add('hidden');
                bookList.classList.remove('hidden');

                books.forEach(book => {
                    const row = document.createElement('tr');
                    row.id = book.id; 
                    const needsReview = book.fictionStatus === 'N/A' || book.genre === 'N/A';
                    const hasArtwork = book.coverImageUrl && book.coverImageUrl !== '';
                    row.innerHTML = `
                        <td class="px-2 py-4 whitespace-nowrap text-gray-400 text-center drag-handle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="inline-block" viewBox="0 0 16 16">
                              <path d="M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1 3a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-1 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm5-7a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM10 8a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-1 4a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                            </svg>
                        </td>
                         <td class="px-6 py-4 whitespace-nowrap">
                             <img src="${book.coverImageUrl || 'https://placehold.co/80x120/e2e8f0/94a3b8?text=No+Image'}" 
                                 alt="Cover of ${book.title}" 
                                 class="h-20 w-auto object-contain rounded-md shadow-sm thumbnail-img cursor-pointer"
                                 onerror="this.onerror=null;this.src='https://placehold.co/80x120/e2e8f0/94a3b8?text=Error';">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${book.title}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.author}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500">${book.monthRead || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap min-w-[120px]">
                            <select data-id="${book.id}" data-field="fictionStatus" class="editable-select text-sm text-gray-500 rounded-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="N/A" ${!book.fictionStatus || book.fictionStatus === 'N/A' ? 'selected' : ''}>N/A</option>
                                <option value="Fiction" ${book.fictionStatus === 'Fiction' ? 'selected' : ''}>Fiction</option>
                                <option value="Non-Fiction" ${book.fictionStatus === 'Non-Fiction' ? 'selected' : ''}>Non-Fiction</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 relative">
                            <div contenteditable="true" data-id="${book.id}" data-field="genre" class="editable-cell min-w-[100px]">${book.genre || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <div contenteditable="true" data-id="${book.id}" data-field="publicationYear" class="editable-cell min-w-[60px]">${book.publicationYear || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            ${needsReview ? `<button data-id="${book.id}" data-title="${book.title}" data-author="${book.author}" class="text-yellow-600 hover:text-yellow-900 review-btn">Review</button>` : ''}
                            ${!hasArtwork ? `<button data-id="${book.id}" data-olid="${book.olid || ''}" data-title="${book.title}" data-author="${book.author}" class="text-blue-600 hover:text-blue-900 artwork-btn">Get Art</button>` : ''}
                            <button data-id="${book.id}" class="text-red-600 hover:text-red-900 delete-btn">Delete</button>
                        </td>
                    `;
                    bookList.appendChild(row);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const bookId = e.target.closest('button').dataset.id;
                        handleDeleteBook(bookId);
                    });
                });
                
                document.querySelectorAll('.review-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const { id, title, author } = e.target.closest('button').dataset;
                        handleReviewBook(id, title, author);
                    });
                });

                document.querySelectorAll('.artwork-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const { id, title, author, olid } = e.target.closest('button').dataset;
                        handleGetArtwork(id, title, author, olid);
                    });
                });

                document.querySelectorAll('.thumbnail-img').forEach(img => {
                    img.addEventListener('click', (e) => openImageModal(e.target.src));
                });

                document.querySelectorAll('.editable-select').forEach(select => select.addEventListener('change', handleCellEdit));
                document.querySelectorAll('.editable-cell[data-field="genre"]').forEach(cell => {
                    cell.addEventListener('focus', handleGenreFocus);
                    cell.addEventListener('input', handleGenreInput);
                    cell.addEventListener('blur', handleCellEdit);
                });
                 document.querySelectorAll('.editable-cell:not([data-field="genre"])').forEach(cell => cell.addEventListener('blur', handleCellEdit));
            }
            initializeSortable();
        }

        async function handleCellEdit(event) {
            const element = event.target;
            const bookId = element.dataset.id;
            const field = element.dataset.field;
            const value = element.tagName === 'SELECT' ? element.value : element.textContent.trim();

            try {
                const bookRef = doc(db, `users/${userId}/books`, bookId);
                await updateDoc(bookRef, { [field]: value });
                element.classList.add('bg-green-100');
                setTimeout(() => element.classList.remove('bg-green-100'), 1500);
            } catch (error) {
                console.error("Error updating book:", error);
                showError("Could not save your change.");
            }
        }

        function fetchAndRenderBooks() {
            if (unsubscribeFromFirestore) unsubscribeFromFirestore();
            if (!db || !userId) return;
            
            const booksCollectionRef = collection(db, `users/${userId}/books`);
            const q = query(booksCollectionRef, where("yearRead", "==", currentYear), orderBy("order", "asc"));

            unsubscribeFromFirestore = onSnapshot(q, (querySnapshot) => {
                const books = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBooks(books);
            }, (error) => {
                console.error("Error fetching books:", error);
                showError("Could not fetch your book list. Please check your connection or refresh.");
            });
        }

        async function handleBulkAdd(e) {
            e.preventDefault();
            const rows = bulkBookRows.querySelectorAll('.grid');
            if (rows.length === 0) {
                showError("Please add at least one book to the list.");
                return;
            }

            setBulkLoading(true);
            let processedCount = 0;
            const totalBooks = rows.length;
            updateBulkProgress(processedCount, totalBooks);

            const booksToAdd = [];
            for (const row of rows) {
                const title = row.querySelector('.bulk-title').value.trim();
                const author = row.querySelector('.bulk-author').value.trim();
                const monthRead = row.querySelector('.bulk-month').value;
                const publicationYear = row.dataset.publicationYear || 'N/A';
                const olid = row.dataset.olid || null;
                const isbn = row.dataset.isbn || null;

                if (title && author && monthRead) {
                    try {
                        const bookData = await fetchBookDataWithRetry(title, author, olid);
                        booksToAdd.push({
                            title, author, monthRead, yearRead: currentYear,
                            publicationYear: publicationYear,
                            fictionStatus: bookData.fictionStatus || 'N/A',
                            genre: bookData.genre || 'N/A',
                            coverImageUrl: isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg` : '',
                            olid: olid,
                            createdAt: new Date()
                        });
                    } catch (error) {
                        console.error(`Failed to fetch data for ${title}:`, error);
                        booksToAdd.push({ title, author, monthRead, yearRead: currentYear, publicationYear, fictionStatus: 'N/A', genre: 'N/A', coverImageUrl: '', olid: null });
                    }
                }
                processedCount++;
                updateBulkProgress(processedCount, totalBooks);
            }

            const batch = writeBatch(db);
            const booksCollectionRef = collection(db, `users/${userId}/books`);
            let currentOrder = bookList.children.length;
            
            booksToAdd.forEach(book => {
                const newBookRef = doc(booksCollectionRef);
                batch.set(newBookRef, { ...book, order: currentOrder++ });
            });

            try {
                await batch.commit();
                await fetchAllUserGenres(); // Refresh genres after adding
                bulkBookRows.innerHTML = '';
                addBulkRow();
                hideError();
            } catch (error) {
                console.error("Error adding books in bulk:", error);
                showError("There was an error saving your books. Please try again.");
            } finally {
                setBulkLoading(false);
            }
        }

        async function handleDeleteBook(bookId) {
            if (confirm('Are you sure you want to delete this book?')) {
                 try {
                    await deleteDoc(doc(db, `users/${userId}/books`, bookId));
                    await fetchAllUserGenres(); // Refresh genres after deleting
                } catch (error) {
                    console.error("Error deleting book:", error);
                    showError("Failed to delete the book. Please try again.");
                }
            }
        }
        
        function initializeSortable() {
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(bookList, {
                handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', onEnd: updateBookOrder,
            });
        }

        async function updateBookOrder() {
            const batch = writeBatch(db);
            const rows = bookList.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (row.id) batch.update(doc(db, `users/${userId}/books`, row.id), { order: index });
            });
            try {
                await batch.commit();
            } catch (error) {
                console.error("Failed to update book order:", error);
                showError("Could not save the new order. Please try again.");
            }
        }

        async function openStatsModal() {
            statsModal.style.display = 'flex';
            document.getElementById('stats-year-btn').textContent = `Stats for ${currentYear}`;
            generateStats('year');
        }

        async function generateStats(scope) {
            statsYearBtn.classList.toggle('bg-gray-100', scope !== 'year');
            statsAllBtn.classList.toggle('bg-gray-100', scope !== 'all');

            const booksCollectionRef = collection(db, `users/${userId}/books`);
            const q = scope === 'year' ? query(booksCollectionRef, where("yearRead", "==", currentYear)) : query(booksCollectionRef);
            const querySnapshot = await getDocs(q);
            const books = querySnapshot.docs.map(doc => doc.data());

            const totalBooks = books.length;
            const authors = books.map(b => b.author);
            const uniqueAuthors = new Set(authors).size;
            
            const authorCounts = authors.reduce((acc, author) => ({...acc, [author]: (acc[author] || 0) + 1}), {});
            const topAuthor = Object.keys(authorCounts).reduce((a, b) => authorCounts[a] > authorCounts[b] ? a : b, 'N/A');

            const fictionCounts = books.reduce((acc, book) => ({...acc, [book.fictionStatus || 'Unknown']: (acc[book.fictionStatus || 'Unknown'] || 0) + 1}), {});
            const genreCounts = books.reduce((acc, book) => ({...acc, [book.genre || 'Unknown']: (acc[book.genre || 'Unknown'] || 0) + 1}), {});
            const sortedGenres = Object.entries(genreCounts).sort(([,a],[,b]) => b-a).slice(0, 5);

            document.getElementById('stats-total-books').textContent = totalBooks;
            document.getElementById('stats-unique-authors').textContent = uniqueAuthors;
            document.getElementById('stats-top-author').textContent = topAuthor;

            updateChart(fictionChart, 'fiction-chart', 'pie', Object.keys(fictionCounts), Object.values(fictionCounts), 'Fiction vs Non-Fiction');
            updateChart(genreChart, 'genre-chart', 'bar', sortedGenres.map(g => g[0]), sortedGenres.map(g => g[1]), 'Top 5 Genres');
        }

        function updateChart(chartInstance, canvasId, type, labels, data, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: ['#4f46e5', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#6366f1', '#a78bfa'],
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            };

            if (type === 'pie') fictionChart = new Chart(ctx, chartConfig);
            if (type === 'bar') genreChart = new Chart(ctx, chartConfig);
        }

        async function handleTitleInput(row) {
            const titleInput = row.querySelector('.bulk-title');
            const suggestionsContainer = row.querySelector('.title-suggestions');
            const title = titleInput.value.trim();
            
            if (title.length < 3) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            
            const suggestions = await fetchBookSuggestions(title);
            showTitleSuggestions(suggestions, row);
        }

        function showTitleSuggestions(suggestions, row) {
            const suggestionsContainer = row.querySelector('.title-suggestions');
            const titleInput = row.querySelector('.bulk-title');
            const authorInput = row.querySelector('.bulk-author');
            suggestionsContainer.innerHTML = '';

            if (suggestions.length > 0) {
                suggestionsContainer.classList.remove('hidden');
                suggestions.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<p class="font-semibold">${book.title}</p><p class="text-sm text-gray-600">${book.author} (${book.publicationYear})</p>`;
                    div.onmousedown = () => {
                        titleInput.value = book.title;
                        authorInput.value = book.author;
                        row.dataset.publicationYear = book.publicationYear;
                        row.dataset.olid = book.olid;
                        row.dataset.isbn = book.isbn;
                        suggestionsContainer.classList.add('hidden');
                    };
                    suggestionsContainer.appendChild(div);
                });
                 document.addEventListener('click', (e) => {
                    if (!titleInput.parentElement.contains(e.target)) {
                       suggestionsContainer.classList.add('hidden');
                    }
                }, { once: true });
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }

        async function handleReviewBook(bookId, title, author) {
            reviewModal.style.display = 'flex';
            reviewSuggestionsContainer.innerHTML = '<p>Searching for matches...</p>';
            const suggestions = await fetchBookSuggestions(title);
            reviewSuggestionsContainer.innerHTML = '';

            if (suggestions.length > 0) {
                suggestions.forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item flex justify-between items-center';
                    div.innerHTML = `<div><p class="font-semibold">${book.title}</p><p class="text-sm text-gray-600">${book.author} (${book.publicationYear})</p></div>`;
                    const selectBtn = document.createElement('button');
                    selectBtn.textContent = 'Select';
                    selectBtn.className = 'ml-4 px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full';
                    selectBtn.onclick = async () => {
                        const bookData = await fetchBookDataWithRetry(book.title, book.author, book.olid);
                        await updateDoc(doc(db, `users/${userId}/books`, bookId), {
                            title: book.title,
                            author: book.author,
                            publicationYear: book.publicationYear,
                            fictionStatus: bookData.fictionStatus,
                            genre: bookData.genre,
                            coverImageUrl: book.isbn ? `https://covers.openlibrary.org/b/isbn/${book.isbn}-L.jpg` : '',
                            olid: book.olid
                        });
                        reviewModal.style.display = 'none';
                    };
                    div.appendChild(selectBtn);
                    reviewSuggestionsContainer.appendChild(div);
                });
            } else {
                reviewSuggestionsContainer.innerHTML = '<p>No likely matches found.</p>';
            }
        }

        async function handleGetArtwork(bookId, title, author, olid) {
            artworkModal.style.display = 'flex';
            artworkSuggestionsContainer.innerHTML = '<p>Searching for artwork...</p>';
            const suggestions = await fetchBookSuggestions(title);
            artworkSuggestionsContainer.innerHTML = '';

            if (suggestions.length > 0) {
                suggestions.forEach(book => {
                    if (book.isbn) {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item text-center';
                        div.innerHTML = `
                            <img src="https://covers.openlibrary.org/b/isbn/${book.isbn}-M.jpg" class="h-40 mx-auto mb-2 rounded-md shadow-sm"/>
                            <button class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full">Select</button>
                        `;
                        div.querySelector('button').onclick = async () => {
                            const coverImageUrl = `https://covers.openlibrary.org/b/isbn/${book.isbn}-L.jpg`;
                             await updateDoc(doc(db, `users/${userId}/books`, bookId), { coverImageUrl, olid: book.olid });
                            artworkModal.style.display = 'none';
                        };
                        artworkSuggestionsContainer.appendChild(div);
                    }
                });
            } 
            
            if (artworkSuggestionsContainer.children.length === 0) {
                artworkSuggestionsContainer.innerHTML = '<p>No artwork found for this book.</p>';
            }
        }

        async function fetchBookSuggestions(searchTerm) {
            try {
                const response = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error('Open Library search failed');
                const data = await response.json();
                return data.docs.slice(0, 5).map(doc => ({
                    title: doc.title,
                    author: doc.author_name ? doc.author_name.join(', ') : 'N/A',
                    publicationYear: doc.first_publish_year || 'N/A',
                    olid: doc.key,
                    isbn: doc.isbn ? doc.isbn[0] : null
                }));
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        async function fetchBookData(title, author, olid) {
            const prompt = `For the book "${title}" by "${author}" (Open Library ID: ${olid || 'Unknown'}), provide whether it is "Fiction" or "Non-Fiction", and its primary genre. If you cannot find a confident match, return "N/A" for the unknown fields.`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: { fictionStatus: { type: "STRING" }, genre: { type: "STRING" } },
                        required: ["fictionStatus", "genre"]
                    }
                }
            };
            const apiKey = firebaseConfig.apiKey; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]) {
                return JSON.parse(result.candidates[0].content.parts[0].text);
            }
            return { fictionStatus: 'N/A', genre: 'N/A' };
        }
        
        async function fetchBookDataByIsbn(isbn) {
            try {
                const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`);
                if (!response.ok) throw new Error('Open Library API request failed');
                const data = await response.json();
                const bookKey = `ISBN:${isbn}`;
                if (data[bookKey]) {
                    const book = data[bookKey];
                    return {
                        title: book.title,
                        author: book.authors ? book.authors.map(a => a.name).join(', ') : 'N/A',
                        publicationYear: book.publish_date || 'N/A',
                        olid: data[bookKey].key,
                        isbn: isbn
                    };
                }
            } catch (error) {
                console.error("Open Library API failed.", error);
            }
            return null;
        }

        async function handleIsbnSearch() {
            const isbn = isbnInput.value.trim();
            if (!isbn) return;
            try {
                const bookData = await fetchBookDataByIsbn(isbn);
                if (bookData && bookData.title) {
                    addBulkRow(bookData);
                    isbnInput.value = '';
                } else {
                    showError(`Could not find a book with ISBN: ${isbn}`);
                }
            } catch (error) {
                console.error(error);
                showError("There was an error searching by ISBN.");
            }
        }

        async function fetchBookDataWithRetry(title, author, olid, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fetchBookData(title, author, olid);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }
        
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        function setBulkLoading(isLoading) {
            addAllBtn.disabled = isLoading;
            bulkLoader.classList.toggle('hidden', !isLoading);
            addAllBtnText.classList.toggle('hidden', isLoading);
            bulkProgressContainer.classList.toggle('hidden', !isLoading);
        }

        function updateBulkProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            bulkProgressLabel.textContent = `Processing ${current} of ${total} books...`;
            bulkProgressBar.style.width = `${percentage}%`;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        function downloadCsvTemplate(e, type) {
            e.preventDefault();
            let csvContent, fileName;
            if (type === 'isbn') {
                csvContent = "data:text/csv;charset=utf-8," 
                    + "ISBN,Month\n"
                    + "9780345391803,January\n";
                fileName = "book_template_isbn.csv";
            } else {
                csvContent = "data:text/csv;charset=utf-8," 
                    + "Title,Author,Month\n"
                    + "\"The Hobbit\",\"J.R.R. Tolkien\",January\n";
                fileName = "book_template_title.csv";
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = text.split('\n').filter(row => row.trim() !== '');
                if (rows.length === 0) return;
                
                const header = rows.shift().toLowerCase();

                bulkBookRows.innerHTML = '';

                if (header.includes('isbn')) {
                    for (const rowStr of rows) {
                        const columns = rowStr.split(',');
                        if (columns.length >= 2) {
                            const isbn = columns[0].replace(/"/g, '').trim();
                            const month = columns[1].replace(/"/g, '').trim();
                            if (isbn && month) {
                                try {
                                    const bookData = await fetchBookDataByIsbn(isbn);
                                    if (bookData) {
                                        addBulkRow({ ...bookData, month });
                                    }
                                } catch (error) {
                                    console.error(`Failed to find book for ISBN ${isbn}`);
                                }
                            }
                        }
                    }
                } else {
                    rows.forEach(rowStr => {
                        const columns = rowStr.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                        if (columns.length >= 3) {
                            const book = {
                                title: columns[0].replace(/"/g, '').trim(),
                                author: columns[1].replace(/"/g, '').trim(),
                                month: columns[2].replace(/"/g, '').trim()
                            };
                            if (book.title && book.author && book.month) {
                                addBulkRow(book);
                            }
                        }
                    });
                }
                
                if (bulkBookRows.children.length === 0) {
                    addBulkRow();
                }
            };
            reader.readAsText(file);
            csvFileInput.value = '';
        }

        async function fetchAllUserGenres() {
            if (!db || !userId) return;
            const booksCollectionRef = collection(db, `users/${userId}/books`);
            const querySnapshot = await getDocs(booksCollectionRef);
            const genres = new Set();
            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (data.genre && data.genre !== 'N/A') {
                    genres.add(data.genre);
                }
            });
            allUserGenres = Array.from(genres);
        }

        function handleGenreFocus(event) {
            const cell = event.target;
            handleGenreInput({ target: cell }); // Show all genres on focus
        }

        function handleGenreInput(event) {
            const cell = event.target;
            const filterText = cell.textContent.toLowerCase();
            const filteredGenres = allUserGenres.filter(g => g.toLowerCase().includes(filterText));
            showGenreSuggestions(filteredGenres, cell);
        }

        function showGenreSuggestions(genres, cell) {
            genreSuggestionsContainer.innerHTML = '';
            if (genres.length > 0) {
                const cellRect = cell.getBoundingClientRect();
                genreSuggestionsContainer.style.left = `${cellRect.left}px`;
                genreSuggestionsContainer.style.top = `${cellRect.bottom}px`;
                genreSuggestionsContainer.style.width = `${cellRect.width}px`;
                genreSuggestionsContainer.classList.remove('hidden');

                genres.forEach(genre => {
                    const div = document.createElement('div');
                    div.textContent = genre;
                    div.className = 'suggestion-item';
                    div.onmousedown = () => {
                        cell.textContent = genre;
                        genreSuggestionsContainer.classList.add('hidden');
                        cell.blur(); // Trigger the save
                    };
                    genreSuggestionsContainer.appendChild(div);
                });

                document.addEventListener('click', (e) => {
                    if (!cell.contains(e.target) && !genreSuggestionsContainer.contains(e.target)) {
                        genreSuggestionsContainer.classList.add('hidden');
                    }
                }, { once: true });
            } else {
                genreSuggestionsContainer.classList.add('hidden');
            }
        }
        
        function openImageModal(src) {
            if (src.includes('placehold.co')) return;
            fullImage.src = src;
            imageModal.style.display = "flex";
        }

        function closeImageModal() {
            imageModal.style.display = "none";
        }


        window.onload = initializeFirebase;

    </script>
</body>
</html>
